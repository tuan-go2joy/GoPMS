var mo=Object.defineProperty,io=Object.defineProperties;var po=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var co=Object.prototype.hasOwnProperty,fo=Object.prototype.propertyIsEnumerable;var A=(n,o,t)=>o in n?mo(n,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[o]=t,S=(n,o)=>{for(var t in o||(o={}))co.call(o,t)&&A(n,t,o[t]);if(b)for(var t of b(o))fo.call(o,t)&&A(n,t,o[t]);return n},_=(n,o)=>io(n,po(o));import{Q as P}from"./QCardSection.c854a72b.js";import{Q as yo}from"./QCard.819f10fc.js";import{Q as V,a as So}from"./queryKeys.553e4145.js";import{aO as H,aP as _o,d as K,a3 as z,aQ as G,n as J,s as C,aU as vo,o as L,a1 as W,a2 as w,u as a,c as U,F as Ro,a5 as To,a as v,h as X,M as Qo,y as Y,v as go,t as $,i as Fo}from"./vendor.6afcc2f0.js";import{d as Z}from"./useI18n.cd288b87.js";import{Q as ho}from"./QSkeleton.e2532b07.js";import{a as oo,Q as Co}from"./axiosClient.264e3cda.js";import{Q as j}from"./QSelect.4297c779.js";import{Q as Lo}from"./QForm.cdc811d8.js";import{C as wo}from"./ClosePopup.49e1b2a3.js";import{u as Vo}from"./useNotify.ae0ad5bc.js";import{u as Oo}from"./useRoomTypeFloorInfoQuery.eae95df3.js";import{u as eo}from"./useRoomTypeListQuery.b1ab00a3.js";import{_ as qo}from"./plugin-vue_export-helper.21dcd24c.js";import"./use-prevent-scroll.3abd3655.js";import"./QMenu.23017405.js";const ko=async n=>{const{data:o}=await oo.post("/configuration/room/createRoom",n);return o},Do=()=>H(ko,{onSuccess:()=>{}}),Uo=async n=>{const{data:o}=await oo.post("/configuration/room/updateRoom",n);return o},xo=()=>{const n=_o(),{findRoomTypeBySn:o}=eo(),t=e=>{const u=n.getQueryData(V.FLOORS);if(!u)return;const{data:m}=u;if(!m)return;const p=m.flatMap(({roomList:R,sn:i,name:T})=>R.map(O=>_(S({},O),{floorSn:i,floorName:T}))).find(R=>R.sn===e.sn);if(!p)return;const r=o(e.roomTypeSn);if(!!r)return n.setQueryData(V.FLOORS,()=>{switch(p.floorSn!==e.floorSn){case!0:return _(S({},u),{data:m.map(i=>i.sn!==e.floorSn?_(S({},i),{roomList:i.roomList.filter(T=>T.sn!==e.sn)}):_(S({},i),{roomList:[...i.roomList,{sn:e.sn,name:e.name,roomTypeCode:r.code,roomTypeSn:e.roomTypeSn}]}))});case!1:return _(S({},u),{data:m.map(i=>i.sn!==e.floorSn?i:_(S({},i),{roomList:i.roomList.map(T=>T.sn!==e.sn?T:{sn:e.sn,name:e.name,roomTypeCode:r.code,roomTypeSn:e.roomTypeSn})}))})}}),p.roomTypeCode},F=(e,u)=>{const m=n.getQueryData(V.ROOM_TYPES);if(!m||!u)return;const{data:p}=m;!p||n.setQueryData(V.ROOM_TYPES,()=>_(S({},m),{data:p.map(r=>r.sn===e.roomTypeSn?_(S({},r),{numOfRoom:r.numOfRoom+1}):r.code===u?_(S({},r),{numOfRoom:r.numOfRoom-1}):r)}))};return H(Uo,{onSuccess:(e,u)=>{const m=t(u);F(u,m)}})};const Io={key:0,class:"wrapper"},Mo={key:1,class:"wrapper"},Bo={class:"q-mt-md row justify-end q-gutter-md"},No=K({props:{roomSn:null},emits:["onRequestSuccess"],setup(n,{emit:o}){var N,E;const t=n,{notifySaveSuccess:F,notifySaveFailed:e}=Vo(),u=z(),m=G(),{data:p,isLoading:r,refetch:R,findRoomTypeByCode:i}=eo(),{data:T,isLoading:O,findRoomByRoomSn:to,findFloorByRoomSn:no}=Oo(),x=Do(),I=xo(),M=J(()=>O.value||r.value),ro=Array.isArray(m.query.code)||(N=m.query.code)==null?void 0:N.replaceAll("_"," "),ao=(E=i(ro))==null?void 0:E.sn,l=C({name:""});vo(()=>{var s,d,f;if(t.roomSn==="new")l.value={roomTypeSn:ao,floorSn:u.options.history.state.floorId,name:""};else{const c=to(t.roomSn);l.value={roomTypeSn:(s=i(c==null?void 0:c.roomTypeCode))==null?void 0:s.sn,floorSn:(d=no(t.roomSn))==null?void 0:d.sn,name:(f=c==null?void 0:c.name)!=null?f:""}}});const q=C(null),B=[s=>!!s||y("this_field_is_required"),s=>Number.isInteger(s)||y("this_is_invalid_value")],k=C(null),so=B,D=C(null),uo=[s=>!!s||y("this_field_is_required"),s=>s.length<=50||y("this_value_is_too_long"),s=>{var d,f;return!((f=(d=T.value)==null?void 0:d.data)==null?void 0:f.some(({roomList:c})=>c.some(({name:g,sn:Q})=>t.roomSn==="new"?g===s:g===s&&Q!==t.roomSn)))||y("this_is_invalid_value")}],{t:y}=Z(),lo=()=>{var s,d,f,c,h,g;if((s=D.value)==null||s.validate(),(d=k.value)==null||d.validate(),(f=q.value)==null||f.validate(),!(((c=D.value)==null?void 0:c.error)||((h=k.value)==null?void 0:h.error)||((g=q.value)==null?void 0:g.error))&&!(!l.value.floorSn||!l.value.roomTypeSn)){if(t.roomSn==="new"){x.mutate({roomTypeSn:l.value.roomTypeSn,floorSn:l.value.floorSn,name:l.value.name},{onSuccess:()=>{F(),R.value(),o("onRequestSuccess")},onError:()=>{e()}});return}I.mutate({sn:t.roomSn,roomTypeSn:l.value.roomTypeSn,floorSn:l.value.floorSn,name:l.value.name},{onSuccess:()=>{F(),o("onRequestSuccess")},onError:()=>{e()}})}};return(s,d)=>(L(),W(Lo,{onSubmit:lo},{default:w(()=>{var f,c,h,g;return[a(M)?(L(),U("div",Io,[(L(),U(Ro,null,To(3,Q=>v(ho,{key:Q,type:"QInput"})),64))])):(L(),U("div",Mo,[v(Co,{ref_key:"nameField",ref:D,modelValue:l.value.name,"onUpdate:modelValue":d[0]||(d[0]=Q=>l.value.name=Q),label:a(y)("room_name"),rules:uo},null,8,["modelValue","label"]),v(j,{ref_key:"roomTypeField",ref:k,modelValue:l.value.roomTypeSn,"onUpdate:modelValue":d[1]||(d[1]=Q=>l.value.roomTypeSn=Q),label:a(y)("room_type"),rules:a(so),options:(c=(f=a(p))==null?void 0:f.data)!=null?c:void 0,"map-options":"","option-label":"code","option-value":"sn","emit-value":""},null,8,["modelValue","label","rules","options"]),v(j,{ref_key:"floorSnField",ref:q,modelValue:l.value.floorSn,"onUpdate:modelValue":d[2]||(d[2]=Q=>l.value.floorSn=Q),label:a(y)("floor"),rules:B,options:(g=(h=a(T))==null?void 0:h.data)!=null?g:void 0,"map-options":"","option-label":"name","option-value":"sn","emit-value":""},null,8,["modelValue","label","options"])])),X("div",Bo,[Qo(v(Y,{label:a(y)("cancel"),flat:"",type:"button"},null,8,["label"]),[[wo]]),v(Y,{label:a(y)("save"),color:"orange-9",type:"submit",disable:a(M),loading:a(x).isLoading.value||a(I).isLoading.value},null,8,["label","disable","loading"])])]}),_:1}))}});var Eo=qo(No,[["__scopeId","data-v-29bd4e5e"]]);const bo={class:"text-h6"},re=K({setup(n){const o=z(),t=G(),{t:F}=Z(),e=C(!1),u=J(()=>{const{roomSn:p}=t.params;return Array.isArray(p)?null:p==="new"?"new":typeof+p=="number"?+p:null});go(()=>e.value=!0);const m=()=>{o.replace({path:"/settings/room-settings",query:t.query})};return(p,r)=>a(u)?(L(),W(So,{key:0,modelValue:e.value,"onUpdate:modelValue":r[1]||(r[1]=R=>e.value=R),onHide:m},{default:w(()=>[v(yo,{style:{width:"500px","max-width":"80vw"}},{default:w(()=>[v(P,null,{default:w(()=>[X("div",bo,$(a(u)==="new"?a(F)("new_room"):a(F)("edit_room"))+" "+$(a(o).options.history.state.roomName),1)]),_:1}),v(P,{class:"q-pt-none"},{default:w(()=>[v(Eo,{"room-sn":a(u),onOnRequestSuccess:r[0]||(r[0]=R=>e.value=!1)},null,8,["room-sn"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):Fo("",!0)}});export{re as default};
