var uo=Object.defineProperty,lo=Object.defineProperties;var mo=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var io=Object.prototype.hasOwnProperty,po=Object.prototype.propertyIsEnumerable;var b=(n,o,r)=>o in n?uo(n,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[o]=r,R=(n,o)=>{for(var r in o||(o={}))io.call(o,r)&&b(n,r,o[r]);if(E)for(var r of E(o))po.call(o,r)&&b(n,r,o[r]);return n},T=(n,o)=>lo(n,mo(o));import{Q as N}from"./QCardSection.c854a72b.js";import{Q as co}from"./QCard.819f10fc.js";import{Q as L,a as fo}from"./queryKeys.553e4145.js";import{aO as $,aP as yo,d as j,a3 as H,aQ as K,n as z,s as h,aU as So,o as C,a1 as G,a2 as w,u as l,c as q,F as _o,a5 as vo,a as d,h as J,M as Ro,y as A,v as To,t as P,i as Qo}from"./vendor.6afcc2f0.js";import{d as W}from"./useI18n.cd288b87.js";import{Q as Fo}from"./QSkeleton.e2532b07.js";import{a as X,Q as go}from"./axiosClient.264e3cda.js";import{Q as Y}from"./QSelect.4297c779.js";import{Q as ho}from"./QForm.cdc811d8.js";import{C as Co}from"./ClosePopup.49e1b2a3.js";import{u as wo}from"./useNotify.ae0ad5bc.js";import{u as Lo}from"./useRoomTypeFloorInfoQuery.eae95df3.js";import{u as Z}from"./useRoomTypeListQuery.f3301e23.js";import{_ as Vo}from"./plugin-vue_export-helper.21dcd24c.js";import"./use-prevent-scroll.3abd3655.js";import"./QMenu.23017405.js";const Oo=async n=>{const{data:o}=await X.post("/configuration/room/createRoom",n);return o},ko=()=>$(Oo,{onSuccess:()=>{}}),Uo=async n=>{const{data:o}=await X.post("/configuration/room/updateRoom",n);return o},qo=()=>{const n=yo(),{findRoomTypeBySn:o}=Z(),r=e=>{const a=n.getQueryData(L.FLOORS);if(!a)return;const i=a.flatMap(({roomList:c,sn:s,name:y})=>c.map(V=>T(R({},V),{floorSn:s,floorName:y}))).find(c=>c.sn===e.sn);if(!i)return;const t=o(e.roomTypeSn);if(!!t)return n.setQueryData(L.FLOORS,()=>{switch(i.floorSn!==e.floorSn){case!0:return a.map(s=>s.sn!==e.floorSn?T(R({},s),{roomList:s.roomList.filter(y=>y.sn!==e.sn)}):T(R({},s),{roomList:[...s.roomList,{sn:e.sn,name:e.name,roomTypeCode:t.code,roomTypeSn:e.roomTypeSn}]}));case!1:return a.map(s=>s.sn!==e.floorSn?s:T(R({},s),{roomList:s.roomList.map(y=>y.sn!==e.sn?y:{sn:e.sn,name:e.name,roomTypeCode:t.code,roomTypeSn:e.roomTypeSn})}))}}),i.roomTypeCode},_=(e,a)=>{const i=n.getQueryData(L.ROOM_TYPES);!i||!a||n.setQueryData(L.ROOM_TYPES,()=>i.map(t=>t.sn===e.roomTypeSn?T(R({},t),{numOfRoom:t.numOfRoom+1}):t.code===a?T(R({},t),{numOfRoom:t.numOfRoom-1}):t))};return $(Uo,{onSuccess:(e,a)=>{const i=r(a);_(a,i)}})};const xo={key:0,class:"wrapper"},Io={key:1,class:"wrapper"},Mo={class:"q-mt-md row justify-end q-gutter-md"},Bo=j({props:{roomSn:null},setup(n){var B,D;const o=n,{notifySaveSuccess:r,notifySaveFailed:_}=wo(),e=H(),a=K(),{data:i,isLoading:t,findRoomTypeByCode:c}=Z(),{data:s,isLoading:y,findRoomByRoomSn:V,findFloorByRoomSn:oo}=Lo(),eo=ko(),no=qo(),x=z(()=>y.value||t.value),to=Array.isArray(a.query.code)||(B=a.query.code)==null?void 0:B.replaceAll("_"," "),I=(D=c(to))==null?void 0:D.sn,u=h({name:""});So(()=>{var m,p,S;o.roomSn==="new"?u.value={roomTypeSn:I,floorSn:e.options.history.state.floorId,name:""}:u.value={roomTypeSn:I,floorSn:(m=oo(o.roomSn))==null?void 0:m.sn,name:(S=(p=V(o.roomSn))==null?void 0:p.name)!=null?S:""}});const O=h(null),M=[m=>!!m||f("this_field_is_required"),m=>Number.isInteger(m)||f("this_is_invalid_value")],k=h(null),ro=M,U=h(null),ao=[m=>!!m||f("this_field_is_required"),m=>m.length<=50||f("this_value_is_too_long")],{t:f}=W(),so=()=>{var m,p,S,Q,F,g;if((m=U.value)==null||m.validate(),(p=k.value)==null||p.validate(),(S=O.value)==null||S.validate(),!(((Q=U.value)==null?void 0:Q.error)||((F=k.value)==null?void 0:F.error)||((g=O.value)==null?void 0:g.error))&&!(!u.value.floorSn||!u.value.roomTypeSn)){if(o.roomSn==="new"){eo.mutate({roomTypeSn:u.value.roomTypeSn,floorSn:u.value.floorSn,name:u.value.name},{onSuccess:()=>{r()},onError:()=>{_()}});return}no.mutate({sn:o.roomSn,roomTypeSn:u.value.roomTypeSn,floorSn:u.value.floorSn,name:u.value.name},{onSuccess:()=>{r()},onError:()=>{_()}})}};return(m,p)=>(C(),G(ho,{onSubmit:so},{default:w(()=>{var S,Q,F,g;return[l(x)?(C(),q("div",xo,[(C(),q(_o,null,vo(3,v=>d(Fo,{key:v,type:"QInput"})),64))])):(C(),q("div",Io,[d(go,{ref_key:"nameField",ref:U,modelValue:u.value.name,"onUpdate:modelValue":p[0]||(p[0]=v=>u.value.name=v),label:l(f)("room_name"),rules:ao},null,8,["modelValue","label"]),d(Y,{ref_key:"roomTypeField",ref:k,modelValue:u.value.roomTypeSn,"onUpdate:modelValue":p[1]||(p[1]=v=>u.value.roomTypeSn=v),label:l(f)("room_type"),rules:l(ro),options:(Q=(S=l(i))==null?void 0:S.data)!=null?Q:void 0,"map-options":"","option-label":"code","option-value":"sn","emit-value":""},null,8,["modelValue","label","rules","options"]),d(Y,{ref_key:"floorSnField",ref:O,modelValue:u.value.floorSn,"onUpdate:modelValue":p[2]||(p[2]=v=>u.value.floorSn=v),label:l(f)("floor"),rules:M,options:(g=(F=l(s))==null?void 0:F.data)!=null?g:void 0,"map-options":"","option-label":"name","option-value":"id","emit-value":""},null,8,["modelValue","label","options"])])),J("div",Mo,[Ro(d(A,{label:l(f)("cancel"),flat:"",type:"button"},null,8,["label"]),[[Co]]),d(A,{label:l(f)("save"),color:"orange-9",type:"submit",disable:l(x)},null,8,["label","disable"])])]}),_:1}))}});var Do=Vo(Bo,[["__scopeId","data-v-69b31c93"]]);const Eo={class:"text-h6"},ne=j({setup(n){const o=H(),r=K(),{t:_}=W(),e=h(!1),a=z(()=>{const{roomSn:t}=r.params;return Array.isArray(t)?null:t==="new"?"new":typeof+t=="number"?+t:null});To(()=>e.value=!0);const i=()=>{o.replace({path:"/settings/room-settings",query:r.query})};return(t,c)=>l(a)?(C(),G(fo,{key:0,modelValue:e.value,"onUpdate:modelValue":c[0]||(c[0]=s=>e.value=s),onHide:i},{default:w(()=>[d(co,{style:{width:"500px","max-width":"80vw"}},{default:w(()=>[d(N,null,{default:w(()=>[J("div",Eo,P(l(a)==="new"?l(_)("new_room"):l(_)("edit_room"))+" "+P(l(o).options.history.state.roomName),1)]),_:1}),d(N,{class:"q-pt-none"},{default:w(()=>[d(Do,{"room-sn":l(a)},null,8,["room-sn"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):Qo("",!0)}});export{ne as default};
