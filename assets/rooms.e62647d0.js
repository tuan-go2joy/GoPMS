var _o=Object.defineProperty,co=Object.defineProperties;var po=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var N=(o,e,r)=>e in o?_o(o,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[e]=r,c=(o,e)=>{for(var r in e||(e={}))$.call(e,r)&&N(o,r,e[r]);if(b)for(var r of b(e))P.call(e,r)&&N(o,r,e[r]);return o},p=(o,e)=>co(o,po(e));var Y=(o,e)=>{var r={};for(var n in o)$.call(o,n)&&e.indexOf(n)<0&&(r[n]=o[n]);if(o!=null&&b)for(var n of b(o))e.indexOf(n)<0&&P.call(o,n)&&(r[n]=o[n]);return r};import{Q as A}from"./QCardSection.b278b73a.js";import{Q as fo}from"./QCard.7c0ad1c3.js";import{Q,a as yo}from"./queryKeys.336f5b66.js";import{aN as Z,aO as z,aw as vo,d as G,_ as J,aP as W,k as X,n as I,aT as Ro,o as S,$ as D,a0 as w,u as l,c as k,F as Qo,a4 as go,a as f,Z as oo,I as Co,s as K,p as ho,a2 as j,a3 as Fo}from"./vendor.71878d25.js";import{d as eo}from"./useI18n.26b256e3.js";import{Q as Io}from"./QSkeleton.863a1ca4.js";import{a as T,Q as So}from"./axiosClient.da76d854.js";import{Q as H}from"./QSelect.1cdad3a5.js";import{Q as wo}from"./QForm.0f37de0d.js";import{C as bo}from"./ClosePopup.cdbaede7.js";import{u as Oo}from"./useNotify.2ba89e99.js";import{u as x}from"./useRoomTypesQuery.2b2e1ed3.js";import{u as Mo,a as Vo}from"./useRoomsQuery.fed9440d.js";import{_ as qo}from"./plugin-vue_export-helper.21dcd24c.js";import"./use-prevent-scroll.15991844.js";import"./QMenu.1058eb8d.js";const ko=async o=>{const{data:e}=await T.post("/rooms/create/",o);return e},To=()=>{const o=z(),{findRoomTypeCodeById:e}=x(),r=t=>{const s=o.getQueryData(Q.ROOMS),u=e(t.room_type);!s||!u||o.setQueryData(Q.ROOMS,()=>s.map(a=>a.room_floor_id!==t.room_floor?a:p(c({},a),{list_rooms:[{id:t.id,name:t.name,room_type_code:u,room_type_id:t.id},...a.list_rooms]})))},n=t=>{const s=o.getQueryData(Q.ROOM_TYPES);!s||o.setQueryData(Q.ROOM_TYPES,()=>s.map(u=>u.id!==t.room_type?u:p(c({},u),{num_of_room:u.num_of_room+1})))};return Z(ko,{onSuccess:t=>{n(t),r(t)}})},xo=async({queryKey:o})=>{const[,e]=o;if(!e)return;const{data:r}=await T.get(`/rooms/get/${e}`);return r},Eo=o=>{const e=[Q.ROOMS,o];return vo(e,xo)},Lo=async r=>{var n=r,{room_id:o}=n,e=Y(n,["room_id"]);const{data:t}=await T.put(`/rooms/update/${o}`,c({},e));return t},Uo=()=>{const o=z(),{findRoomTypeCodeById:e}=x(),r=t=>{const s=o.getQueryData(Q.ROOMS);if(!s)return;const u=s.flatMap(({list_rooms:y,room_floor_id:i,room_floor_name:g})=>y.map(O=>p(c({},O),{room_floor_id:i,room_floor_name:g}))).find(y=>y.id===t.id);if(!u)return;const a=e(t.room_type);if(!!a)return o.setQueryData(Q.ROOMS,()=>{switch(u.room_floor_id!==t.room_floor){case!0:return s.map(i=>i.room_floor_id!==t.room_floor?p(c({},i),{list_rooms:i.list_rooms.filter(g=>g.id!==t.id)}):p(c({},i),{list_rooms:[...i.list_rooms,{id:t.id,name:t.name,room_type_code:a,room_type_id:t.room_type}]}));case!1:return s.map(i=>i.room_floor_id!==t.room_floor?i:p(c({},i),{list_rooms:i.list_rooms.map(g=>g.id!==t.id?g:{id:t.id,name:t.name,room_type_code:a,room_type_id:t.room_type})}))}}),u.room_type_code},n=(t,s)=>{const u=o.getQueryData(Q.ROOM_TYPES);!u||!s||o.setQueryData(Q.ROOM_TYPES,()=>u.map(a=>a.id===t.room_type?p(c({},a),{num_of_room:a.num_of_room+1}):a.code===s?p(c({},a),{num_of_room:a.num_of_room-1}):a))};return Z(Lo,{onSuccess:t=>{const s=r(t);n(t,s)}})};const Bo={key:0,class:"wrapper"},No={key:1,class:"wrapper"},$o={class:"q-mt-md row justify-end q-gutter-md"},Po=G({props:{roomId:{type:[String,Number],required:!0}},setup(o){var B;const e=o,{notifySaveSuccess:r,notifySaveFailed:n}=Oo(),t=J(),s=W(),{data:u,isLoading:a,findRoomTypeIdByCode:y}=x(),{data:i,isLoading:g}=Mo(),{findRoomByRoomId:O,isLoading:to}=Vo(),{data:E,isLoading:ro}=Eo(e.roomId==="new"?0:e.roomId),ao=To(),no=Uo(),L=X(()=>a.value||g.value||to.value||ro.value),so=Array.isArray(s.query.code)||(B=s.query.code)==null?void 0:B.replaceAll("_"," "),uo=y(so),v=I({name:""});Ro(()=>{var m,_,d,C,h,F;v.value={room_floor_id:(_=(m=E.value)==null?void 0:m.room_floor)!=null?_:t.options.history.state.floorId,room_type_id:(C=(d=E.value)==null?void 0:d.room_type)!=null?C:uo,name:e.roomId==="new"?"":(F=(h=O(e.roomId))==null?void 0:h.name)!=null?F:""}});const M=I(null),U=[m=>!!m||R("this_field_is_required"),m=>Number.isInteger(m)||R("this_is_invalid_value")],V=I(null),io=U,q=I(null),lo=[m=>!!m||R("this_field_is_required"),m=>m.length<=50||R("this_value_is_too_long")],{t:R}=eo(),mo=()=>{var m,_,d,C,h,F;if((m=q.value)==null||m.validate(),(_=V.value)==null||_.validate(),(d=M.value)==null||d.validate(),!(((C=q.value)==null?void 0:C.error)||((h=V.value)==null?void 0:h.error)||((F=M.value)==null?void 0:F.error))){if(e.roomId==="new"){ao.mutate(v.value,{onSuccess:()=>{r()},onError:()=>{n()}});return}no.mutate(p(c({},v.value),{room_id:e.roomId}),{onSuccess:()=>{r()},onError:()=>{n()}})}};return(m,_)=>(S(),D(wo,{onSubmit:mo},{default:w(()=>[l(L)?(S(),k("div",Bo,[(S(),k(Qo,null,go(3,d=>f(Io,{key:d,type:"QInput"})),64))])):(S(),k("div",No,[f(So,{ref_key:"nameField",ref:q,modelValue:v.value.name,"onUpdate:modelValue":_[0]||(_[0]=d=>v.value.name=d),label:l(R)("room_name"),rules:lo},null,8,["modelValue","label"]),f(H,{ref_key:"roomTypeField",ref:V,modelValue:v.value.room_type_id,"onUpdate:modelValue":_[1]||(_[1]=d=>v.value.room_type_id=d),label:l(R)("room_type"),rules:l(io),options:l(u),"map-options":"","option-label":"code","option-value":"id","emit-value":""},null,8,["modelValue","label","rules","options"]),f(H,{ref_key:"roomFloorField",ref:M,modelValue:v.value.room_floor_id,"onUpdate:modelValue":_[2]||(_[2]=d=>v.value.room_floor_id=d),label:l(R)("floor"),rules:U,options:l(i),"map-options":"","option-label":"name","option-value":"id","emit-value":""},null,8,["modelValue","label","options"])])),oo("div",$o,[Co(f(K,{label:l(R)("cancel"),flat:"",type:"button"},null,8,["label"]),[[bo]]),f(K,{label:l(R)("save"),color:"orange-9",type:"submit",disable:l(L)},null,8,["label","disable"])])]),_:1}))}});var Yo=qo(Po,[["__scopeId","data-v-7fc45f50"]]);const Ao={class:"text-h6"},ue=G({setup(o){const e=J(),r=W(),{t:n}=eo(),t=I(!1),s=X(()=>{const{roomId:a}=r.params;return Array.isArray(a)?null:a==="new"?"new":typeof+a=="number"?+a:null});ho(()=>t.value=!0);const u=()=>{e.replace({path:"/settings/room-settings",query:r.query})};return(a,y)=>l(s)?(S(),D(yo,{key:0,modelValue:t.value,"onUpdate:modelValue":y[0]||(y[0]=i=>t.value=i),onHide:u},{default:w(()=>[f(fo,{style:{width:"500px","max-width":"80vw"}},{default:w(()=>[f(A,null,{default:w(()=>[oo("div",Ao,j(l(s)==="new"?l(n)("new_room"):l(n)("edit_room"))+" "+j(l(e).options.history.state.roomName),1)]),_:1}),f(A,{class:"q-pt-none"},{default:w(()=>[f(Yo,{"room-id":l(s)},null,8,["room-id"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):Fo("v-if",!0)}});export{ue as default};
