var lo=Object.defineProperty,mo=Object.defineProperties;var io=Object.getOwnPropertyDescriptors;var N=Object.getOwnPropertySymbols;var po=Object.prototype.hasOwnProperty,co=Object.prototype.propertyIsEnumerable;var b=(n,e,t)=>e in n?lo(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,v=(n,e)=>{for(var t in e||(e={}))po.call(e,t)&&b(n,t,e[t]);if(N)for(var t of N(e))co.call(e,t)&&b(n,t,e[t]);return n},R=(n,e)=>mo(n,io(e));import{Q as A}from"./QCardSection.c854a72b.js";import{Q as fo}from"./QCard.819f10fc.js";import{Q as w,a as yo}from"./queryKeys.553e4145.js";import{aO as j,aP as So,d as H,a3 as K,aQ as z,n as G,s as C,aU as _o,o as L,a1 as J,a2 as h,u as s,c as U,F as vo,a5 as Ro,a as f,h as W,M as To,y as P,v as Qo,t as Y,i as go}from"./vendor.6afcc2f0.js";import{d as X}from"./useI18n.cd288b87.js";import{Q as Fo}from"./QSkeleton.e2532b07.js";import{a as Z,Q as Co}from"./axiosClient.264e3cda.js";import{Q as $}from"./QSelect.4297c779.js";import{Q as Lo}from"./QForm.cdc811d8.js";import{C as ho}from"./ClosePopup.49e1b2a3.js";import{u as wo}from"./useNotify.ae0ad5bc.js";import{u as Vo}from"./useRoomTypeFloorInfoQuery.eae95df3.js";import{u as oo}from"./useRoomTypeListQuery.b1ab00a3.js";import{_ as Oo}from"./plugin-vue_export-helper.21dcd24c.js";import"./use-prevent-scroll.3abd3655.js";import"./QMenu.23017405.js";const qo=async n=>{const{data:e}=await Z.post("/configuration/room/createRoom",n);return e},ko=()=>j(qo,{onSuccess:()=>{}}),Uo=async n=>{const{data:e}=await Z.post("/configuration/room/updateRoom",n);return e},xo=()=>{const n=So(),{findRoomTypeBySn:e}=oo(),t=o=>{const u=n.getQueryData(w.FLOORS);if(!u)return;const m=u.flatMap(({roomList:r,sn:a,name:S})=>r.map(V=>R(v({},V),{floorSn:a,floorName:S}))).find(r=>r.sn===o.sn);if(!m)return;const i=e(o.roomTypeSn);if(!!i)return n.setQueryData(w.FLOORS,()=>{switch(m.floorSn!==o.floorSn){case!0:return u.map(a=>a.sn!==o.floorSn?R(v({},a),{roomList:a.roomList.filter(S=>S.sn!==o.sn)}):R(v({},a),{roomList:[...a.roomList,{sn:o.sn,name:o.name,roomTypeCode:i.code,roomTypeSn:o.roomTypeSn}]}));case!1:return u.map(a=>a.sn!==o.floorSn?a:R(v({},a),{roomList:a.roomList.map(S=>S.sn!==o.sn?S:{sn:o.sn,name:o.name,roomTypeCode:i.code,roomTypeSn:o.roomTypeSn})}))}}),m.roomTypeCode},T=(o,u)=>{const m=n.getQueryData(w.ROOM_TYPES);if(!m||!u)return;const{data:i}=m;!i||n.setQueryData(w.ROOM_TYPES,()=>R(v({},m),{data:i.map(r=>r.sn===o.roomTypeSn?R(v({},r),{numOfRoom:r.numOfRoom+1}):r.code===u?R(v({},r),{numOfRoom:r.numOfRoom-1}):r)}))};return j(Uo,{onSuccess:(o,u)=>{const m=t(u);T(u,m)}})};const Io={key:0,class:"wrapper"},Mo={key:1,class:"wrapper"},Bo={class:"q-mt-md row justify-end q-gutter-md"},Do=H({props:{roomSn:null},emits:["onRequestSuccess"],setup(n,{emit:e}){var D,E;const t=n,{notifySaveSuccess:T,notifySaveFailed:o}=wo(),u=K(),m=z(),{data:i,isLoading:r,findRoomTypeByCode:a}=oo(),{data:S,isLoading:V,findRoomByRoomSn:eo,findFloorByRoomSn:no}=Vo(),x=ko(),I=xo(),M=G(()=>V.value||r.value),to=Array.isArray(m.query.code)||(D=m.query.code)==null?void 0:D.replaceAll("_"," "),ro=(E=a(to))==null?void 0:E.sn,l=C({name:""});_o(()=>{var p,d,_;if(t.roomSn==="new")l.value={roomTypeSn:ro,floorSn:u.options.history.state.floorId,name:""};else{const c=eo(t.roomSn);l.value={roomTypeSn:(p=a(c==null?void 0:c.roomTypeCode))==null?void 0:p.sn,floorSn:(d=no(t.roomSn))==null?void 0:d.sn,name:(_=c==null?void 0:c.name)!=null?_:""}}});const O=C(null),B=[p=>!!p||y("this_field_is_required"),p=>Number.isInteger(p)||y("this_is_invalid_value")],q=C(null),ao=B,k=C(null),so=[p=>!!p||y("this_field_is_required"),p=>p.length<=50||y("this_value_is_too_long")],{t:y}=X(),uo=()=>{var p,d,_,c,g,F;if((p=k.value)==null||p.validate(),(d=q.value)==null||d.validate(),(_=O.value)==null||_.validate(),!(((c=k.value)==null?void 0:c.error)||((g=q.value)==null?void 0:g.error)||((F=O.value)==null?void 0:F.error))&&!(!l.value.floorSn||!l.value.roomTypeSn)){if(t.roomSn==="new"){x.mutate({roomTypeSn:l.value.roomTypeSn,floorSn:l.value.floorSn,name:l.value.name},{onSuccess:()=>{T(),e("onRequestSuccess")},onError:()=>{o()}});return}I.mutate({sn:t.roomSn,roomTypeSn:l.value.roomTypeSn,floorSn:l.value.floorSn,name:l.value.name},{onSuccess:()=>{T()},onError:()=>{o()}})}};return(p,d)=>(L(),J(Lo,{onSubmit:uo},{default:h(()=>{var _,c,g,F;return[s(M)?(L(),U("div",Io,[(L(),U(vo,null,Ro(3,Q=>f(Fo,{key:Q,type:"QInput"})),64))])):(L(),U("div",Mo,[f(Co,{ref_key:"nameField",ref:k,modelValue:l.value.name,"onUpdate:modelValue":d[0]||(d[0]=Q=>l.value.name=Q),label:s(y)("room_name"),rules:so},null,8,["modelValue","label"]),f($,{ref_key:"roomTypeField",ref:q,modelValue:l.value.roomTypeSn,"onUpdate:modelValue":d[1]||(d[1]=Q=>l.value.roomTypeSn=Q),label:s(y)("room_type"),rules:s(ao),options:(c=(_=s(i))==null?void 0:_.data)!=null?c:void 0,"map-options":"","option-label":"code","option-value":"sn","emit-value":""},null,8,["modelValue","label","rules","options"]),f($,{ref_key:"floorSnField",ref:O,modelValue:l.value.floorSn,"onUpdate:modelValue":d[2]||(d[2]=Q=>l.value.floorSn=Q),label:s(y)("floor"),rules:B,options:(F=(g=s(S))==null?void 0:g.data)!=null?F:void 0,"map-options":"","option-label":"name","option-value":"id","emit-value":""},null,8,["modelValue","label","options"])])),W("div",Bo,[To(f(P,{label:s(y)("cancel"),flat:"",type:"button"},null,8,["label"]),[[ho]]),f(P,{label:s(y)("save"),color:"orange-9",type:"submit",disable:s(M),loading:s(x).isLoading.value||s(I).isLoading.value},null,8,["label","disable","loading"])])]}),_:1}))}});var Eo=Oo(Do,[["__scopeId","data-v-47e34c80"]]);const No={class:"text-h6"},te=H({setup(n){const e=K(),t=z(),{t:T}=X(),o=C(!1),u=G(()=>{const{roomSn:i}=t.params;return Array.isArray(i)?null:i==="new"?"new":typeof+i=="number"?+i:null});Qo(()=>o.value=!0);const m=()=>{e.replace({path:"/settings/room-settings",query:t.query})};return(i,r)=>s(u)?(L(),J(yo,{key:0,modelValue:o.value,"onUpdate:modelValue":r[1]||(r[1]=a=>o.value=a),onHide:m},{default:h(()=>[f(fo,{style:{width:"500px","max-width":"80vw"}},{default:h(()=>[f(A,null,{default:h(()=>[W("div",No,Y(s(u)==="new"?s(T)("new_room"):s(T)("edit_room"))+" "+Y(s(e).options.history.state.roomName),1)]),_:1}),f(A,{class:"q-pt-none"},{default:h(()=>[f(Eo,{"room-sn":s(u),onOnRequestSuccess:r[0]||(r[0]=a=>o.value=!1)},null,8,["room-sn"])]),_:1})]),_:1})]),_:1},8,["modelValue"])):go("",!0)}});export{te as default};
